<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Self-Service Order Kiosk</title>
  <style>
    :root{--sidebar-width:260px;--gap:12px;--accent:#0b79f7;--bg:#f6f7fb}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    html,body,#app{height:100%;margin:0;background:var(--bg)}
    #app{display:flex;flex-direction:column}
    .main{flex:1;display:flex;gap:var(--gap);padding:12px}

    /* LEFT: Categories (fixed width, vertical unscrollable list) */
    .sidebar{width:var(--sidebar-width);background:#fff;border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:8px;align-items:stretch}
    .cats{display:flex;flex-direction:column;gap:8px;overflow:hidden}
    .cat{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .cat.active{background:linear-gradient(90deg, rgba(11,121,247,0.06), rgba(11,121,247,0.02));border-color:rgba(11,121,247,0.12)}
    .cat img{width:44px;height:44px;object-fit:cover;border-radius:6px}
    .cat .meta{display:flex;flex-direction:column}
    .cat .meta .title{font-weight:600}
    .cat .meta .sub{font-size:12px;color:#666}
    .cat .badge{margin-left:auto;background:#eee;padding:4px 8px;border-radius:999px;font-size:12px}

    /* RIGHT: Products grid */
    .content{flex:1;display:flex;flex-direction:column;gap:12px}
    .grid-wrap{flex:1;overflow:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .card{background:#fff;padding:10px;border-radius:8px;display:flex;flex-direction:column;gap:8px;align-items:stretch}
    .thumb{width:100%;height:110px;object-fit:cover;border-radius:6px;cursor:pointer}
    .card .row{display:flex;align-items:center;gap:8px}
    .card .title{font-weight:600}
    .card .price{margin-left:auto;font-weight:700}
    .small-badge{font-size:12px;color:#333;background:#f3f4f6;padding:4px 6px;border-radius:6px}

    /* bottom bar */
    .bottombar{height:64px;background:#fff;border-radius:8px;padding:10px;display:flex;align-items:center;gap:12px}
    .summary{display:flex;flex-direction:column}
    .summary .big{font-weight:700;font-size:18px}
    .checkout-btn{margin-left:auto;background:var(--accent);color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:700;cursor:pointer}

    /* modals */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;padding:20px}
    .overlay.show{display:flex}
    .modal{background:#fff;border-radius:10px;max-width:840px;width:100%;max-height:90vh;overflow:auto;padding:18px}
    .modal .top{display:flex;gap:16px}
    .modal .bigimg{width:320px;height:320px;object-fit:cover;border-radius:8px}
    .modal .right{flex:1;display:flex;flex-direction:column;gap:8px}
    .addons-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .addon{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #f0f0f0}
    .qty-controls{display:flex;align-items:center;gap:8px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:none}

    /* checkout list */
    .checkout-list{display:flex;flex-direction:column;gap:8px}
    .checkout-item{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;background:#fff}
    .checkout-item img{width:56px;height:56px;object-fit:cover;border-radius:6px}
    .tax-row{display:flex;justify-content:space-between;font-weight:700}

    /* responsive tweaks */
    @media (max-width:880px){:root{--sidebar-width:160px}}
    @media (max-width:640px){.main{flex-direction:column}.sidebar{width:100%;order:2}.content{order:1}}
  </style>
</head>
<body>
  <div id="app">
    <div class="main">
      <aside class="sidebar">
        <div style="font-weight:800">Categories</div>
        <div class="cats" id="cats"></div>
      </aside>

      <section class="content">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="font-weight:800;font-size:18px">Menu</div>
          <div id="selectedCategoryTitle" style="color:#666">All</div>
        </div>

        <div class="grid-wrap"><div class="grid" id="products"></div></div>

      </section>
    </div>

    <div style="padding:12px">
      <div class="bottombar">
        <div class="summary">
          <div id="itemCount">0 items</div>
          <div class="big" id="totalPrice">0.00</div>
        </div>
        <button class="checkout-btn" id="checkoutBtn">Checkout</button>
      </div>
    </div>
  </div>

  <!-- product modal -->
  <div class="overlay" id="productModal">
    <div class="modal" role="dialog">
      <div class="top">
        <img id="pmImg" class="bigimg" src="" alt="product">
        <div class="right">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div id="pmTitle" style="font-weight:800;font-size:20px"></div>
              <div id="pmDesc" style="color:#666;font-size:13px;margin-top:6px"></div>
            </div>
            <div style="text-align:right">
              <div style="font-size:18px;font-weight:800" id="pmUnit">0.00</div>
              <div style="font-size:12px;color:#666">unit price</div>
            </div>
          </div>

          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
            <div class="qty-controls">
              <button class="btn" id="pmMinus">-</button>
              <div id="pmQty">1</div>
              <button class="btn" id="pmPlus">+</button>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700">Total</div>
              <div id="pmTotal">0.00</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Note</label>
            <input id="pmNote" placeholder="Add note" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px" />
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Add-ons</div>
            <div class="addons-list" id="pmAddons"></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" id="pmCancel">CANCEL</button>
            <button class="btn primary" id="pmConfirm">CONFIRM</button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- checkout modal -->
  <div class="overlay" id="checkoutModal">
    <div class="modal" style="max-width:760px">
      <h3>Checkout</h3>
      <div class="checkout-list" id="checkoutList"></div>
      <div style="margin-top:12px">
        <div class="tax-row"><div>Subtotal</div><div id="coSubtotal">0.00</div></div>
        <div class="tax-row"><div>Tax (<span id="taxRateLabel"></span>)</div><div id="coTax">0.00</div></div>
        <div class="tax-row" style="font-size:20px;margin-top:8px"><div>Total</div><div id="coTotal">0.00</div></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div></div>
        <div>
          <button class="btn" id="coClose">CLOSE</button>
          <button class="btn primary" id="coCheckout">CHECKOUT</button>
        </div>
      </div>
    </div>
  </div>

  <!-- final qr page modal -->
  <div class="overlay" id="qrModal">
    <div class="modal" style="max-width:420px;text-align:center">
      <h3>Pay with QR</h3>
      <img id="qrImg" src="" alt="qr" style="width:260px;height:260px;object-fit:contain" />
      <div style="margin-top:12px;font-size:14px;color:#666">Scan to pay</div>
    </div>
  </div>

  <script>
    // Data placeholders
    let images = [];
    let cats = [];
    let addons = [];
    let menu = [];
    const taxRate = 0.06; // changeable if needed

    // Cart structure: array of entries {id, addons:[id], note, quantity, unitPrice}
    let cart = [];

    // Load menu data on start
    async function loadData(){
      try{
        // attempt to fetch /menu.json
        const res = await fetch('/menu.json');
        if(!res.ok) throw new Error('no menu.json');
        const d = await res.json();
        images = d.images||[]; cats = d.cats||[]; addons = d.addons||[]; menu = d.menu||[];
      }catch(e){
        // fallback sample data
        images = [{id:1,src:'https://picsum.photos/seed/1/600/400'},{id:2,src:'https://picsum.photos/seed/2/600/400'},{id:3,src:'https://picsum.photos/seed/3/600/400'}];
        cats = [{id:1,title:'Hot Drinks',description:'Warm beverages',image:1},{id:2,title:'Cold Drinks',description:'Icy & refreshing',image:2},{id:3,title:'Snacks',description:'Light bites',image:3}];
        addons = [{id:11,title:'Extra Shot',description:'Add espresso shot',price:0.8,image:1},{id:12,title:'Syrup',description:'Vanilla',price:0.5,image:2}];
        menu = [{id:101,title:'Americano',description:'Classic',price:3.5,image:1,category:0,addons:[11]},{id:102,title:'Iced Tea',description:'Lemon',price:2.8,image:2,category:1,addons:[12]},{id:103,title:'Cookie',description:'Chocolate chip',price:1.6,image:3,category:2,addons:[]}];
      }
      renderCats();
      renderProducts();
      document.getElementById('taxRateLabel').textContent = (taxRate*100).toFixed(0)+"%";
    }

    function imgById(id){const f=images.find(x=>x.id===id);return f?f.src:''}

    // RENDERING
    let selectedCategory = null; // index in cats array
    function renderCats(){
      const el = document.getElementById('cats'); el.innerHTML = '';
      cats.forEach((c,idx)=>{
        const div = document.createElement('div'); div.className='cat'+(selectedCategory===idx?' active':''); div.dataset.idx=idx;
        div.innerHTML = `<img src="${imgById(c.image)||''}" alt=""><div class="meta"><div class="title">${c.title}</div><div class="sub">${c.description||''}</div></div><div class="badge" id="cat-badge-${idx}">0</div>`;
        div.addEventListener('click',()=>{selectedCategory = idx; document.getElementById('selectedCategoryTitle').textContent = c.title; renderCats(); renderProducts();});
        el.appendChild(div);
      });
      // All categories selector
      const all = document.createElement('div'); all.className='cat'+(selectedCategory===null?' active':''); all.style.marginTop='6px'; all.innerHTML = `<img src="https://picsum.photos/seed/all/80/80" style="width:44px;height:44px;border-radius:6px"><div class="meta"><div class="title">All</div><div class="sub">Show all</div></div><div class="badge">&nbsp;</div>`;
      all.addEventListener('click',()=>{selectedCategory=null; document.getElementById('selectedCategoryTitle').textContent='All'; renderCats(); renderProducts();});
      el.insertBefore(all, el.firstChild);
    }

    function renderProducts(){
      const el = document.getElementById('products'); el.innerHTML = '';
      const list = menu.map((m,idx)=>({m,idx})).filter(x=> selectedCategory===null ? true : x.m.category===selectedCategory);
      list.forEach(({m,idx})=>{
        const div = document.createElement('div'); div.className='card';
        const thumb = imgById(m.image)||'';
        div.innerHTML = `<img class="thumb" src="${thumb}" data-id="${m.id}"><div style="display:flex;align-items:center"><div class="title">${m.title}</div><div class="price">${m.price.toFixed(2)}</div></div><div style="display:flex;gap:8px;align-items:center"><div class="small-badge">${m.description||''}</div><div style="margin-left:auto" id="prod-count-${m.id}"></div></div>`;
        // image click opens modal
        div.querySelector('.thumb').addEventListener('click',()=>openProductModal(m));
        el.appendChild(div);
      });
      updateBadges();
    }

    // CART HELPERS
    function makeKey(entry){ // unique by id x addons x note
      const a = (entry.addons||[]).slice().sort((a,b)=>a-b).join(',');
      const n = (entry.note||'').trim();
      return `${entry.id}::${a}::${n}`;
    }

    function findCartEntryIndex(entry){
      const key = makeKey(entry);
      return cart.findIndex(c=>makeKey(c)===key);
    }

    function addToCart(entry){
      const idx = findCartEntryIndex(entry);
      if(idx>-1){ cart[idx].quantity += entry.quantity; }
      else cart.push(Object.assign({},entry));
      refreshUI();
    }

    function updateBadges(){
      // per category totals
      const perCat = cats.map(()=>0);
      cart.forEach(it=>{
        const m = menu.find(x=>x.id===it.id);
        if(m && typeof m.category!=='undefined' && m.category!==null) perCat[m.category] += it.quantity;
      });
      perCat.forEach((v,i)=>{ const el = document.getElementById('cat-badge-'+i); if(el) el.textContent = v>0?v:''});
      // product counts
      menu.forEach(m=>{
        const total = cart.filter(c=>c.id===m.id).reduce((s,x)=>s+x.quantity,0);
        const el = document.getElementById('prod-count-'+m.id);
        if(el) el.textContent = total?`${total} selected`:'';
      });
    }

    function refreshUI(){
      // update bottom bar
      const totalQ = cart.reduce((s,x)=>s+x.quantity,0);
      const totalP = cart.reduce((s,x)=>{
        const unit = x.unitPrice||0; const addonsTotal = (x.addons||[]).reduce((aa,id)=>{const ad = addons.find(a=>a.id===id); return aa + (ad?ad.price:0)},0);
        return s + (unit + addonsTotal) * x.quantity;
      },0);
      document.getElementById('itemCount').textContent = `${totalQ} item${totalQ!==1?'s':''}`;
      document.getElementById('totalPrice').textContent = totalP.toFixed(2);
      updateBadges();
    }

    // PRODUCT MODAL
    let currentProduct = null; let currentQty = 1; let currentSelectedAddons = new Set();
    function openProductModal(p){
      currentProduct = p; currentQty = 1; currentSelectedAddons = new Set();
      document.getElementById('pmImg').src = imgById(p.image)||'';
      document.getElementById('pmTitle').textContent = p.title;
      document.getElementById('pmDesc').textContent = p.description||'';
      document.getElementById('pmUnit').textContent = p.price.toFixed(2);
      document.getElementById('pmQty').textContent = currentQty;
      document.getElementById('pmNote').value = '';
      renderPmAddons(p.addons||[]);
      updatePmTotal();
      document.getElementById('productModal').classList.add('show');
    }
    function closeProductModal(){ document.getElementById('productModal').classList.remove('show'); }
    function renderPmAddons(list){
      const el = document.getElementById('pmAddons'); el.innerHTML = '';
      list.forEach(aid=>{const a = addons.find(x=>x.id===aid); if(!a) return; const d=document.createElement('label'); d.className='addon'; d.innerHTML = `<input type="checkbox" data-id="${a.id}"> <div style="flex:1"><div style="font-weight:700">${a.title}</div><div style="font-size:12px;color:#666">${a.description||''}</div></div><div style="font-weight:700">+${a.price.toFixed(2)}</div>`; d.querySelector('input').addEventListener('change',e=>{ if(e.target.checked) currentSelectedAddons.add(a.id); else currentSelectedAddons.delete(a.id); updatePmTotal(); }); el.appendChild(d);} )
    }
    function updatePmTotal(){
      const unit = currentProduct.price || 0;
      const addonsTotal = Array.from(currentSelectedAddons).reduce((s,id)=>{const a=addons.find(x=>x.id===id); return s + (a? a.price:0)},0);
      const total = (unit + addonsTotal) * currentQty;
      document.getElementById('pmTotal').textContent = total.toFixed(2);
    }

    document.getElementById('pmPlus').addEventListener('click',()=>{ currentQty++; document.getElementById('pmQty').textContent=currentQty; updatePmTotal(); });
    document.getElementById('pmMinus').addEventListener('click',()=>{ if(currentQty>1) currentQty--; document.getElementById('pmQty').textContent=currentQty; updatePmTotal(); });
    document.getElementById('pmCancel').addEventListener('click',()=>{ closeProductModal(); });
    document.getElementById('pmConfirm').addEventListener('click',()=>{
      const entry = {id: currentProduct.id, quantity: currentQty, unitPrice: currentProduct.price, addons: Array.from(currentSelectedAddons), note: document.getElementById('pmNote').value||''};
      addToCart(entry); closeProductModal();
    });

    // CHECKOUT
    document.getElementById('checkoutBtn').addEventListener('click',()=>{
      openCheckout();
    });
    function openCheckout(){
      const el = document.getElementById('checkoutList'); el.innerHTML = '';
      let subtotal = 0;
      cart.forEach(it=>{
        const m = menu.find(x=>x.id===it.id) || {title:'Item',image:null};
        const div = document.createElement('div'); div.className='checkout-item';
        const thumb = imgById(m.image)||'';
        const addonsText = (it.addons||[]).map(aid=>{const a=addons.find(x=>x.id===aid);return a? a.title+'(+'+a.price.toFixed(2)+')':''}).join(', ');
        const addonsPrice = (it.addons||[]).reduce((s,id)=>{const a=addons.find(x=>x.id===id);return s+(a? a.price:0)},0);
        const total = (it.unitPrice + addonsPrice) * it.quantity;
        subtotal += total;
        div.innerHTML = `<img src="${thumb}"><div style="flex:1"><div style="font-weight:700">${m.title}</div><div style="font-size:13px;color:#666">Qty: ${it.quantity} ${addonsText?('<br>'+addonsText):''} ${it.note?('<br>Note: '+escapeHtml(it.note)):''}</div></div><div style="font-weight:800">${total.toFixed(2)}</div>`;
        el.appendChild(div);
      });
      const tax = subtotal * taxRate; const total = subtotal + tax;
      document.getElementById('coSubtotal').textContent = subtotal.toFixed(2);
      document.getElementById('coTax').textContent = tax.toFixed(2);
      document.getElementById('coTotal').textContent = total.toFixed(2);
      document.getElementById('checkoutModal').classList.add('show');
    }
    document.getElementById('coClose').addEventListener('click',()=>document.getElementById('checkoutModal').classList.remove('show'));
    document.getElementById('coCheckout').addEventListener('click',()=>{
      // prepare checkout payload and show QR
      const payload = collect();
      const q = JSON.stringify(payload);
      const qrUrl = 'https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=' + encodeURIComponent(q);
      document.getElementById('qrImg').src = qrUrl;
      document.getElementById('checkoutModal').classList.remove('show');
      document.getElementById('qrModal').classList.add('show');
    });

    // util
    function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    // COLLECT function as requested
    function collect(){
      const items = cart.map(it=>({id: it.id, quantity: it.quantity, totalprice: (()=>{const addonsPrice = (it.addons||[]).reduce((s,id)=>{const a=addons.find(x=>x.id===id);return s + (a? a.price:0)},0); return ((it.unitPrice || 0) + addonsPrice) * it.quantity;})(), note: it.note||'', addons: (it.addons||[]).slice() }));
      const totalprice = items.reduce((s,i)=>s + (i.totalprice||0),0);
      const totalquantity = items.reduce((s,i)=>s + (i.quantity||0),0);
      return {totalprice, totalquantity, items};
    }
    // expose collect globally for caller usage
    window.collect = collect;

    // init
    loadData();

    // make sure modals close on outside click
    document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('show'); }));

  </script>
</body>
</html>
