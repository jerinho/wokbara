<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wok & Bara</title>
  <style>
    :root{--left-width: 260px; --card-max-width: 240px; --gap: 12px; --bottom-height: 72px; --popup-width: 620px; --tax-rate: 0.07;}
    *{box-sizing:border-box;font-family:Inter, system-ui, Arial, sans-serif}
    html,body,#app{height:100%;margin:0}
    body{display:flex;flex-direction:column;background:#f6f7fb}
    .container{display:grid;grid-template-columns:var(--left-width) 1fr;gap:var(--gap);padding:var(--gap);height:calc(100vh - var(--bottom-height));}
    .categories{background:#fff;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:8px;overflow:hidden}
    .cat-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .cat-item img{width:44px;height:44px;object-fit:cover;border-radius:8px}
    .cat-item .meta{flex:1;display:flex;flex-direction:column}
    .cat-item .meta .title{font-weight:600}
    .cat-item .count{font-weight:700;min-width:28px;text-align:right}
    .cat-item.active{background:#eef2ff}
    .products-area{background:#fff;border-radius:10px;padding:12px;overflow:auto}
    .products-grid{display:grid;grid-gap:12px;align-content:start}
    .card{display:flex;flex-direction:column;border-radius:10px;padding:10px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,0.03);border:1px solid #eee;min-height:120px}
    .thumb{width:100%;height:120px;object-fit:cover;border-radius:8px;cursor:pointer}
    .card .title{font-weight:600;}
    .card .price{margin-top:6px;color:#333}
    .card .qty{margin-top:auto;display:flex;align-items:center;justify-content:space-between}
    .card .qty .selected{font-size:13px}
    .card .actions button{padding:6px 8px;border-radius:6px;border:none;background:#0b5fff;color:#fff;cursor:pointer}
    .bottom-bar{height:var(--bottom-height);display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-top:1px solid #eee}
    .summary{display:flex;gap:18px;align-items:center}
	.button{padding:12px 18px;border-radius:10px;border:none;background:#0b5fff;color:#fff;font-weight:700;cursor:pointer}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;padding:20px}
    .overlay.show{display:flex}
    .modal{width:var(--popup-width);max-width:calc(100% - 40px);background:#fff;border-radius:12px;padding:18px;display:flex;gap:14px}
    .modal .left{width:320px}
    .modal img{width:100%;height:auto;border-radius:8px;object-fit:cover}
    .modal .right{flex:1;display:flex;flex-direction:column}
    .modal .right h3{margin:0}
    .modal .right .desc{margin-top:6px;color:#555}
    .modal .right .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .qty-controls{display:flex;gap:8px;align-items:center}
    .qty-controls button{width:36px;height:36px;border-radius:8px;border:none;background:#eee;cursor:pointer}
    .addon-list{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:160px;overflow:auto}
    .addon-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #f0f0f0}
    .checkout-modal{width:640px;max-width:calc(100% - 40px)}
    .checkout-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding:10px}
    .checkout-item{display:flex;gap:8px;align-items:flex-start}
    .checkout-item img{width:56px;height:56px;object-fit:cover;border-radius:6px}
    .small{font-size:13px;color:#666}	
	#current-category-title{display:none;}
    @media (max-width:700px){:root{--left-width:90px}}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
	const firebaseConfig = {
	  apiKey: "AIzaSyBHgIKGh3DfqKQGsM-AfQjnVo4GEtpUDXs",
	  authDomain: "semestaalamsemulajadi.firebaseapp.com",
	  projectId: "semestaalamsemulajadi",
	  storageBucket: "semestaalamsemulajadi.firebasestorage.app",
	  messagingSenderId: "911910247061",
	  appId: "1:911910247061:web:453d0751b85d76d7db599c",
	  measurementId: "G-NR4TQ8KC21"
	};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    async function loadItems() {
      const snap = await getDocs(collection(db, "gizi"));
      const list = [];
      snap.forEach(doc => {
        list.push({ id: doc.id, ...doc.data() });
      });
      console.log("Products:", list);
      document.getElementById("output").textContent = JSON.stringify(list, null, 2);
    }
	window.loadItems = loadItems;
  </script>
</head>
<body>
  <div id="app">
    <div class="container">
      <aside class="categories" id="cats"></aside>
      <main class="products-area">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong id="current-category-title">All</strong></div>
        </div>
        <div class="products-grid" id="productsGrid"></div>
      </main>
    </div>

    <div class="bottom-bar">
      <div class="summary">
        <div class="small">Items: <strong id="totalCount">0</strong></div>
        <div class="small">Total: <strong id="totalPrice">0.00</strong></div>
      </div>
      <div>
        <button class="button" id="btnloaditems" onclick="loadItems()">LOAD ITEMS</button>
        <button class="button" id="checkoutBtn">CHECKOUT</button>
      </div>
    </div>

    <!-- product popup -->
    <div class="overlay" id="productOverlay">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="left">
          <img id="modalImage" src="" alt="product image">
          <h3 id="modalTitle">Product</h3>
          <div class="desc" id="modalDesc"></div>
          <div class="row">
            <div>Unit price: <strong id="modalPrice">0.00</strong></div>
          </div>
        </div>
        <div class="right">
          <div class="row" style="margin-top:12px;align-items:center">
            <div class="qty-controls">
              <button id="decBtn">-</button>
              <div id="modalQty">1</div>
              <button id="incBtn">+</button>
            </div>
            <div style="margin-left:auto">Total: <strong id="modalTotal">0.00</strong></div>
          </div>		  
          <div class="row" style="margin-top:12px;align-items:center">
            <div style="flex:1">
              <textarea id="modalNote" placeholder="Note" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;height:100px;resize:none;"></textarea>
            </div>
          </div>
          <div style="margin-top:12px">Add-ons</div>
          <div class="addon-list" id="addonList"></div>
          <div style="margin-top:auto;display:flex;gap:8px;justify-content:flex-end">
            <button id="cancelModal" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff">CANCEL</button>
            <button id="confirmModal" style="padding:8px 12px;border-radius:8px;border:none;background:#0b5fff;color:#fff">CONFIRM</button>
          </div>
        </div>
      </div>
    </div>

    <!-- checkout overlay -->
    <div class="overlay" id="checkoutOverlay">
      <div class="modal checkout-modal">
        <div style="flex:1;display:flex;flex-direction:column;height:80vh">
          <h3>Order summary</h3>
          <div class="checkout-list" id="checkoutList"></div>
          <div style="margin-top:auto;padding-top:10px;border-top:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Subtotal: <strong id="subTotal">0.00</strong></div>
              <div class="small">Tax (<span id="taxRate">0%</span>): <strong id="taxAmount">0.00</strong></div>
              <div class="small">Total: <strong id="checkoutTotal">0.00</strong></div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
              <button id="goToPay" class="button">CHECKOUT</button>
              <button id="closeCheckout" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff">CANCEL</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- payment / qr overlay -->
    <div class="overlay" id="payOverlay">
      <div class="modal checkout-modal">
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:12px;padding:20px">
          <h3>Scan to Pay</h3>
          <img id="qrImage" alt="qr code" style="width:220px;height:220px;background:#eee;border-radius:12px">
          <div class="small">Show this QR to complete payment.</div>
          <div style="margin-top:auto;display:flex;gap:8px">
            <button id="closePay" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff">CLOSE</button>
            <button id="clearCart" style="padding:8px 12px;border-radius:8px;border:none;background:#ff4d4f;color:#fff">CLEAR CART</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* Configuration parameters (modifiable) */
    const config = {
      maxColumns: 4,      // maximum number of columns
      cardMaxWidth: 240,  // card max width in px
      taxRate: 0.07       // tax percentage (0.07 = 7%)
    };

    document.documentElement.style.setProperty('--card-max-width', config.cardMaxWidth + 'px');
    document.documentElement.style.setProperty('--tax-rate', config.taxRate);
    document.getElementById('taxRate').innerText = (config.taxRate*100).toFixed(0) + '%';

    // elements
    const catsEl = document.getElementById('cats');
    const productsGrid = document.getElementById('productsGrid');
    const totalCountEl = document.getElementById('totalCount');
    const totalPriceEl = document.getElementById('totalPrice');
    const currentCategoryTitle = document.getElementById('current-category-title');

    // overlays
    const productOverlay = document.getElementById('productOverlay');
    const checkoutOverlay = document.getElementById('checkoutOverlay');
    const payOverlay = document.getElementById('payOverlay');

    // modal fields
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const modalPrice = document.getElementById('modalPrice');
    const modalTotal = document.getElementById('modalTotal');
    const modalQty = document.getElementById('modalQty');
    const addonList = document.getElementById('addonList');
    const modalNote = document.getElementById('modalNote');

    // cart storage: array of items {id, quantity, addons:[], note, price, title, image}
    let cart = [];

    // store menu data
    let DATA = {images:[],cats:[],addons:[],menu:[]};
    let currentCatIndex = null;

    // fetch menu data on load (expects JSON at /menu.json). fallback to sample data.
    async function loadData(){
      try{
        const resp = await fetch('/menu.json');
        if(!resp.ok) throw new Error('no menu.json');
        const j = await resp.json();
        DATA = j;
      }catch(e){
        console.warn('fetch menu.json failed, using sample data', e);
        DATA = sampleData();
      }

      renderCategories();
      setGridColumns();
      renderProducts();
      window.addEventListener('resize', setGridColumns);
    }

    function sampleData(){
      return {
        images:[
          {id:0,src:'https://picsum.photos/seed/1/800/600'},
          {id:1,src:'https://picsum.photos/seed/2/800/600'},
          {id:2,src:'https://picsum.photos/seed/3/800/600'}
        ],
        cats:[
          {id:0,title:'All',description:'All items',image:0},
          {id:1,title:'Burgers',description:'Tasty burgers',image:1},
          {id:2,title:'Drinks',description:'Cold drinks',image:2}
        ],
        addons:[
          {id:10,title:'Cheese',description:'Extra cheese',price:0.8,image:0},
          {id:11,title:'Bacon',description:'Crispy bacon',price:1.2,image:0}
        ],
        menu:[
          {id:100,title:'Classic Burger',description:'Beef patty',price:6.5,image:1,category:1,addons:[10,11]},
          {id:101,title:'Veggie Burger',description:'Plant based',price:6.0,image:1,category:1,addons:[10]},
          {id:200,title:'Coke',description:'330ml',price:1.8,image:2,category:2,addons:[]}
        ]
      }
    }

    function renderCategories(){
      catsEl.innerHTML = '';
      DATA.cats.forEach((c,idx)=>{
        const imgSrc = (DATA.images[c.image]||{}).src || '';
        const el = document.createElement('div');
        el.className = 'cat-item' + (idx===0 ? ' active' : '');
        el.dataset.idx = idx;
        el.innerHTML = `
          <img src="${imgSrc}" alt="${c.title}">
          <div class="meta"><div class="title">${c.title}</div><div class="small">${c.description||''}</div></div>
          <div class="count" data-count>0</div>
        `;
        el.addEventListener('click', ()=>{selectCategory(idx)});
        catsEl.appendChild(el);
      });
      // default select first (All)
      currentCatIndex = 0;
      updateCategoryCounts();
    }

    function selectCategory(idx){
      currentCatIndex = idx;
      Array.from(catsEl.children).forEach((ch)=>ch.classList.toggle('active', +ch.dataset.idx===idx));
      const title = DATA.cats[idx] ? DATA.cats[idx].title : 'All';
      currentCategoryTitle.innerText = title;
      renderProducts();
    }

    function setGridColumns(){
      const containerWidth = document.querySelector('.products-area').clientWidth - 24;
      const colWidth = Math.min(config.cardMaxWidth, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-max-width'))||config.cardMaxWidth);
      let cols = Math.floor(containerWidth / (colWidth + 12));
      cols = Math.max(1, Math.min(cols, config.maxColumns));
      productsGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
      productsGrid.style.setProperty('--cols', cols);
    }
	
	function renderProducts(){
	  productsGrid.innerHTML = '';
	  const products = DATA.menu.filter(p=> currentCatIndex===0 ? true : p.category===DATA.cats[currentCatIndex].id );
	  products.forEach(p=>{
		const img = (DATA.images[p.image]||{}).src || '';
		const card = document.createElement('div');
		card.className = 'card';
		const selectedCount = countInCart(p.id);
		card.innerHTML = `
		  <img src="${img}" class="thumb" data-id="${p.id}" style="width:100%;height:120px;object-fit:cover;border-radius:8px" />
		  <div class="row" style="display:flex;align-items:center;gap:12px;margin-top:8px">
			<div style="flex:1;display:flex;flex-direction:column;justify-content:center">
			  <div style="display:flex;align-items:center;gap:8px">
				<div class="title">${p.title}</div>
				<div class="selected">(<strong>${selectedCount}</strong>)</div>
			  </div>
			  <div class="price">$${p.price.toFixed(2)}</div>
			</div>
			<div class="qty" style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
			  <div class="actions"><button data-add="${p.id}">Add</button></div>
			</div>
		  </div>
		`;
		// image click -> popup (keep it untouched)
		card.querySelector('.thumb').addEventListener('click', ()=>openProductModal(p));
		// add button
		card.querySelector('button[data-add]').addEventListener('click', ()=>{ openProductModal(p, true); });

		productsGrid.appendChild(card);
	  });
	}

    function countInCart(prodId){
      return cart.reduce((s,it)=> it.id===prodId ? s+it.quantity : s, 0);
    }

    // product modal logic
    let modalState = {product:null,qty:1,selectedAddons:[],note:''};
    function openProductModal(product, quickAdd=false){
      modalState.product = product;
      modalState.qty = quickAdd ? 1 : 1;
      modalState.selectedAddons = [];
      modalState.note = '';
      modalImage.src = (DATA.images[product.image]||{}).src || '';
      modalTitle.innerText = product.title;
      modalDesc.innerText = product.description || '';
      modalPrice.innerText = product.price.toFixed(2);
      modalQty.innerText = modalState.qty;
      modalNote.value = '';
      renderAddonList(product);
      calcModalTotal();
      productOverlay.classList.add('show');
    }

    function renderAddonList(product){
      addonList.innerHTML = '';
      (product.addons||[]).forEach(aid=>{
        const addon = DATA.addons.find(x=>x.id===aid);
        if(!addon) return;
        const el = document.createElement('div');
        el.className = 'addon-item';
        el.innerHTML = `<input type="checkbox" style="height: 25px; width: 25px;" data-id="${addon.id}"> <div style="flex:1"><div style="font-weight:600">${addon.title}</div><div class="small">$${addon.price.toFixed(2)}</div></div>`;
        const cb = el.querySelector('input');
        cb.addEventListener('change', ()=>{
          if(cb.checked) modalState.selectedAddons.push(addon.id);
          else modalState.selectedAddons = modalState.selectedAddons.filter(x=>x!==addon.id);
          calcModalTotal();
        });
        addonList.appendChild(el);
      });
    }

    function calcModalTotal(){
      const p = modalState.product;
      if(!p) return;
      const addonsTotal = (modalState.selectedAddons || []).reduce((s,aid)=>{
        const a = DATA.addons.find(x=>x.id===aid); return s + (a? a.price:0);
      },0);
      const total = (p.price + addonsTotal) * modalState.qty;
      modalTotal.innerText = total.toFixed(2);
    }

    document.getElementById('incBtn').addEventListener('click', ()=>{
      modalState.qty++;
      modalQty.innerText = modalState.qty;
      calcModalTotal();
    });
    document.getElementById('decBtn').addEventListener('click', ()=>{
      if(modalState.qty>1) modalState.qty--;
      modalQty.innerText = modalState.qty;
      calcModalTotal();
    });

    document.getElementById('cancelModal').addEventListener('click', ()=>{
      productOverlay.classList.remove('show');
    });

    document.getElementById('confirmModal').addEventListener('click', ()=>{
      modalState.note = modalNote.value.trim();
      addToCart(modalState.product, modalState.qty, modalState.selectedAddons.slice(), modalState.note);
      productOverlay.classList.remove('show');
    });

    function addToCart(product, qty, addons, note){
      // unify key by id + sorted addons + note
      const key = makeKey(product.id, addons, note);
      const existing = cart.find(it=> it.key===key);
      const baseItem = {id:product.id, price: product.price, title:product.title, image:product.image};
      if(existing){
        existing.quantity += qty;
        existing.totalprice = +(existing.quantity * (existing.price + addonsTotalPrice(addons))).toFixed(2);
      } else {
        const item = Object.assign({}, baseItem, {quantity:qty, addons:addons.slice(), note:note, key});
        item.totalprice = +(item.quantity * (item.price + addonsTotalPrice(addons))).toFixed(2);
        cart.push(item);
      }
      updateCategoryCounts();
      renderProducts();
      refreshBottom();
    }

    function addonsTotalPrice(addons){
      return (addons||[]).reduce((s,aid)=>{ const a = DATA.addons.find(x=>x.id===aid); return s + (a? a.price:0); },0);
    }

    function makeKey(id, addons, note){
      const as = (addons||[]).slice().sort((a,b)=>a-b).join('-');
      return `${id}|${as}|${note||''}`;
    }

    function updateCategoryCounts(){
      // compute counts per category by summing quantities of items that belong to that category
      const counts = {};
      cart.forEach(it=>{
        const menuItem = DATA.menu.find(m=>m.id===it.id);
        const catId = menuItem ? menuItem.category : DATA.cats[0].id;
        counts[catId] = (counts[catId]||0) + it.quantity;
      });
      // update UI
      Array.from(catsEl.children).forEach(ch=>{
        const idx = +ch.dataset.idx;
        const cat = DATA.cats[idx];
        const cnt = counts[cat.id]||0;
        const countEl = ch.querySelector('[data-count]');
        if(countEl) countEl.innerText = cnt;
      });
      refreshBottom();
    }

    function refreshBottom(){
      const totalQty = cart.reduce((s,it)=>s+it.quantity,0);
      const totalPrice = cart.reduce((s,it)=>s + it.totalprice,0);
      totalCountEl.innerText = totalQty;
      totalPriceEl.innerText = totalPrice.toFixed(2);
    }

    // checkout flow
    document.getElementById('checkoutBtn').addEventListener('click', ()=>{
      openCheckout();
    });

	function openCheckout(){
		const listEl = document.getElementById('checkoutList');
		listEl.innerHTML = '';
		cart.forEach(it=>{
		const img = (DATA.images[it.image]||{}).src || '';
		const el = document.createElement('div');
		el.className = 'checkout-item';
		const addonTitles = (it.addons||[]).map(aid=>(DATA.addons.find(a=>a.id===aid)||{}).title).join(', ');
		el.innerHTML = `
		<img src="${img}">
		<div style="flex:1">
		<div style="font-weight:700">${it.title} <span class="small">x${it.quantity}</span></div>
		<div class="small">${addonTitles || ''}</div>
		<div class="small">${it.note || ''}</div>
		</div>
		<div style="min-width:80px;text-align:right">$${it.totalprice.toFixed(2)}</div>
		<button class="delete-item" data-key='${it.key}' style="margin-left:8px;padding:4px 6px;border:none;border-radius:6px;background:#ff4d4f;color:#fff;cursor:pointer">DELETE</button>
		`;
		el.querySelector('.delete-item').addEventListener('click', e => {
		const key = e.currentTarget.dataset.key;
		cart = cart.filter(item => item.key !== key);
		openCheckout(); // refresh checkout list
		renderProducts();
		updateCategoryCounts();
		});
		listEl.appendChild(el);
		});
		const sub = cart.reduce((s,it)=>s + it.totalprice,0);
		const tax = +(sub * config.taxRate);
		const tot = +(sub + tax).toFixed(2);
		document.getElementById('subTotal').innerText = sub.toFixed(2);
		document.getElementById('taxAmount').innerText = tax.toFixed(2);
		document.getElementById('checkoutTotal').innerText = tot.toFixed(2);
		checkoutOverlay.classList.add('show');
	}

    document.getElementById('closeCheckout').addEventListener('click', ()=> checkoutOverlay.classList.remove('show'));
    document.getElementById('goToPay').addEventListener('click', ()=>{
      // generate a simple QR that encodes order summary JSON. Use free QR server
      const payload = JSON.stringify(collect());
      const url = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(payload);
      document.getElementById('qrImage').src = url;
      checkoutOverlay.classList.remove('show');
      payOverlay.classList.add('show');
    });

    document.getElementById('closePay').addEventListener('click', ()=> payOverlay.classList.remove('show'));
    document.getElementById('clearCart').addEventListener('click', ()=>{ cart=[]; refreshBottom(); updateCategoryCounts(); payOverlay.classList.remove('show'); renderProducts(); });

    // collect() function as requested
    function collect(){
      const items = cart.map(it => ({id:it.id, quantity:it.quantity, totalprice:+it.totalprice.toFixed(2), note:it.note, addons: it.addons.slice()}));
      const totalprice = +items.reduce((s,i)=>s + i.totalprice,0).toFixed(2);
      const totalquantity = items.reduce((s,i)=>s + i.quantity,0);
      return { totalprice, totalquantity, items };
    }

    // expose collect to window so user can call it
    window.collect = collect;
    window.kioskConfig = config;

    // load
    loadData();

  </script>
</body>
</html>
